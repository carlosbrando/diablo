<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor de Builds de Druida - Diablo Immortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            background-image: radial-gradient(#1f2937 1px, transparent 0);
            background-size: 40px 40px;
        }
        /* Estilo para a barra de rolagem */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1a202c; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }

        .modal-overlay, .tooltip {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: transform 0.2s ease-in-out;
        }
        .gear-slot, .skill-slot {
            transition: all 0.2s ease-in-out;
        }
        .gear-slot:not(.disabled):hover, .skill-slot:hover {
            transform: scale(1.05);
            border-color: #3b82f6;
        }
        .tooltip {
            pointer-events: none; /* Garante que o tooltip não interfira com o mouse */
        }
    </style>
</head>
<body class="text-gray-200 antialiased">

    <!-- Tooltip -->
    <div id="tooltip" class="fixed z-50 hidden max-w-xs p-3 text-sm font-normal text-white bg-gray-900 border border-gray-700 rounded-lg shadow-lg tooltip">
        <h3 id="tooltip-title" class="font-semibold text-blue-300"></h3>
        <p id="tooltip-desc" class="mt-1 text-gray-300"></p>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-70 z-40 hidden modal-overlay"></div>

    <!-- Essence Modal -->
    <div id="essence-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4" onclick="closeAllModals()">
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col modal-content scale-95" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="essence-modal-title" class="text-xl font-bold text-white">Selecionar Essência</h2>
                <button onclick="closeAllModals()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="essence-modal-content" class="p-4 space-y-3 overflow-y-auto">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </div>
    
    <!-- Skill Modal -->
    <div id="skill-modal" class="fixed inset-0 flex items-center justify-center z-50 hidden p-4" onclick="closeAllModals()">
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col modal-content scale-95" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center p-4 border-b border-gray-700">
                <h2 id="skill-modal-title" class="text-xl font-bold text-white">Selecionar Habilidade</h2>
                <button onclick="closeAllModals()" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="skill-modal-content" class="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 overflow-y-auto">
                <!-- Conteúdo dinâmico -->
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-white tracking-tight">Construtor de Builds de Druida</h1>
            <p class="text-lg text-gray-400 mt-2 max-w-2xl mx-auto">Crie e visualize sua build de Druida para Diablo Immortal de forma interativa.</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Coluna de Controles (Esquerda) -->
            <div class="lg:w-[45%] bg-gray-900/50 backdrop-blur-sm border border-gray-800 p-6 rounded-xl shadow-lg flex flex-col gap-6">
                <div>
                    <h2 class="text-2xl font-semibold text-white mb-4">1. Habilidades</h2>
                    <div id="skill-selection-container" class="flex flex-wrap justify-center gap-4">
                        <!-- Slots de Habilidade serão inseridos aqui -->
                    </div>
                </div>
                 <div class="mt-auto pt-6 flex flex-col sm:flex-row gap-4">
                    <button id="shareBuildBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                        Compartilhar Build
                    </button>
                    <button id="resetBuildBtn" class="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 8a1 1 0 011-1v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101z" clip-rule="evenodd" /></svg>
                        Limpar
                    </button>
                </div>
            </div>

            <!-- Coluna da Build (Direita) -->
            <div class="lg:w-[55%]">
                <div class="sticky top-6">
                    <h2 class="text-2xl font-bold text-white mb-4 text-center lg:text-left">2. Equipamento</h2>
                    <div id="build-sheet" class="grid grid-cols-3 gap-2 sm:gap-4 max-w-md mx-auto">
                        <!-- Layout da Ficha de Personagem -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- BANCO DE DADOS ---
        const allEssences = [];
        const druidSkills = {};
        const transformationSubSkills = {};
        
        // --- BANCO DE DADOS COMPLETOS ---
        allEssences.push(
            // Mão Principal (12)
            { slot: "Mão Principal", name_en: "Staff of Droves", name_pt: "Cajado das Hordas", description: "`Deslizamento` também aumenta sua velocidade de ataque primário em 7% por 5 segundos ao atingir um inimigo, acumulando até 3 vezes." },
            { slot: "Mão Principal", name_en: "Loamskull", name_pt: "Crânio Barroso", description: "`Lobisomem` agora cobre você em fogo ao se transformar, causando dano, queimando os inimigos próximos e gerando explosões de chamas ao desferir acertos críticos com seus ataques primários." },
            { slot: "Mão Principal", name_en: "Branch of Growling Earth", name_pt: "Ramo da Terra Rugiente", description: "O dano de `Terremoto` é aumentado em 20% ao atingir um inimigo desacelerado." },
            { slot: "Mão Principal", name_en: "The Craw", name_pt: "O Bucho", description: "`Urso` agora transforma você em um urso gigante, com alcance de ataque e vida máxima aumentados." },
            { slot: "Mão Principal", name_en: "The Ordered Crook", name_pt: "Cajado dos Ordenados", description: "A transformação de `Lobisomem` agora faz você saltar ao local selecionado, arremessando os inimigos para cima e marcando-os. Sua chance de acerto crítico é aumentada contra inimigos marcados e sua vida é restaurada quando a marca expira." },
            { slot: "Mão Principal", name_en: "Frenzy Reed", name_pt: "Junco Frenético", description: "A duração de `Potência Raivosa` é aumentada em 30% no estado transformado." },
            { slot: "Mão Principal", name_en: "Burnsocket", name_pt: "Engastafogo", description: "`Tornado de Fogo` gera 1 de Energia Primitiva adicional por inimigo atingido, até o máximo de 10." },
            { slot: "Mão Principal", name_en: "Rattling Shell", name_pt: "Casco Estridente", description: "`Evocar Lobos` também aumenta sua velocidade de movimento em 15% para cada evocação de lobo ativa sob seu controle." },
            { slot: "Mão Principal", name_en: "Hundred Wings’ Shade", name_pt: "Sombra das Cem Asas", description: "`Enxame de Corvos` agora faz você avançar em disparada na forma de revoada de corvos, deixando você inatingível durante a investida e causando dano aos inimigos pelo caminho. Parte da recarga é devolvida se nenhum inimigo for atingido." },
            { slot: "Mão Principal", name_en: "Lift the Lowborn", name_pt: "Levanta-plebe", description: "`Terremoto` também concede a você um escudo por 4 segundos que absorve dano e deixa você imune a 1 efeito de perda total de controle." },
            { slot: "Mão Principal", name_en: "Nyteflurry", name_pt: "Turbilhão da Noite", description: "`Enxame de Corvos` agora fortalece você, fazendo com que seus Ataques Primários e Habilidades conjurem corvos que atacam os inimigos automaticamente. Inimigos são Cegos quando os corvos os atingem várias vezes." },
            { slot: "Mão Principal", name_en: "Lunar Cradle", name_pt: "Berço Lunar", description: "`Evocar Lobos` também enfraquece os inimigos próximos, aumentando o dano que eles recebem de você." },

            // Mão Secundária (12)
            { slot: "Mão Secundária", name_en: "Goring Brace", name_pt: "Braçadeira Chifrada", description: "`Golpe Feroz` gera um adicional de 5 de Energia Primitiva ao acertar um inimigo. Isso só pode ocorrer uma vez a cada 3 segundos." },
            { slot: "Mão Secundária", name_en: "Distant Hissing", name_pt: "Sibilar Distante", description: "`Trincho Dilacerante` (Lobisomem) agora talha com as duas garras, liberando um Vento Lacerante em direção aos inimigos à sua frente. Se os inimigos com queimadura estiverem próximos a você, o alcance e o dano do Vento Lacerante aumentam e o Vento repele os inimigos." },
            { slot: "Mão Secundária", name_en: "Hobble Tooth", name_pt: "Rancadente", description: "`Esmagamento` (Urso) agora golpeia o chão para criar uma onda de choque, causando dano e desacelerando os inimigos próximos. Pode ser usado junto com outras habilidades." },
            { slot: "Mão Secundária", name_en: "Ifeh’s Nails", name_pt: "Cravos de Ifeh", description: "`Laceração` (Urso) consome 15 de Energia Primitiva após o uso para reiniciar a recarga. Só pode ocorrer uma vez a cada 12 segundos." },
            { slot: "Mão Secundária", name_en: "Cedarkin", name_pt: "Povo Cedreiro", description: "`Evocar Sábio da Floresta` agora evoca ativamente Sábios da Floresta protetores que orbitam você. Cada Sábio concede redução de dano e imunidade contra um efeito de perda total de controle." },
            { slot: "Mão Secundária", name_en: "Mauler’s Mitt", name_pt: "Luva do Marretador", description: "`Esmagamento` (Urso) agora fortalece você, fazendo com que seus ataques primários golpeiem o chão e causem dano aos inimigos próximos. Acertos críticos fazem espinhos de pedra surgirem da terra, causando dano adicional." },
            { slot: "Mão Secundária", name_en: "Scar Carver", name_pt: "Talha-cicatriz", description: "`Trincho Dilacerante` (Lobisomem) agora faz você avançar em disparada e golpear. Se acertar o ataque, você pode ativar uma sequência poderosa com um golpe amplo, causando dano adicional aos inimigos com pouca vida." },
            { slot: "Mão Secundária", name_en: "Tuskguard", name_pt: "Guarda-presa", description: "`Evocar Sábio da Floresta` agora evoca ativamente 3 Sábios da Floresta que infectam inimigos com Sementes Fumegantes que explodem se o inimigo receber queimadura." },
            { slot: "Mão Secundária", name_en: "Sapling Claw", name_pt: "Garra do Rebento", description: "`Evocar Sábio da Floresta` agora evoca ativamente um anel de Sábios da Floresta que persegue automaticamente os alvos e se autodestrói, causando dano a todos os inimigos próximos." },
            { slot: "Mão Secundária", name_en: "Hungry Blades", name_pt: "Lâminas Glutonas", description: "Sua evocação de `Urso-cinzento` gera 2 de Energia Primitiva ao receber dano. Só pode ocorrer uma vez a cada segundo." },
            { slot: "Mão Secundária", name_en: "Wulftear", name_pt: "Lágrima Lupina", description: "`Trincho Dilacerante` (Lobisomem) agora é uma série de ataques cortantes com garras que causam dano e Atordoam os inimigos. Usar outras habilidades antes aumenta o número de ataques." },
            { slot: "Mão Secundária", name_en: "Ravenous Wilds", name_pt: "Ermos Vorazes", description: "O dano de `Armadura de Espinhos` também estilhaça a armadura inimiga, aumentando o Dano de Acerto Crítico que eles recebem por um tempo limitado, até um máximo." },

            // Elmo (12)
            { slot: "Elmo", name_en: "Spangblain", name_pt: "Pustulação", description: "`Tornado de Fogo` agora alveja um local, formando um Cone das Cinzas que puxa os inimigos próximos e depois explode com chamas que causam dano e arremessam os inimigos para cima." },
            { slot: "Elmo", name_en: "Trailing-Vine", name_pt: "Vinherrante", description: "`Armadura de Espinhos` também aumenta sua chance de acerto crítico em 8% enquanto estiver ativa." },
            { slot: "Elmo", name_en: "Spring Veil", name_pt: "Véu Primaveril", description: "`Arrancada` (Urso) agora pode ser ativada ou desativada. Quando ativada, consome Energia Primitiva para avançar em disparada continuamente, causando dano e repelindo os inimigos pelo caminho." },
            { slot: "Elmo", name_en: "Mask of Pouncing", name_pt: "Máscara do Bote", description: "`Investida do Cervo` também aumenta sua geração de Energia Primitiva em 30% por 3 segundos." },
            { slot: "Elmo", name_en: "Snarling Face", name_pt: "Cara Rosnada", description: "`Avanço` (Lobisomem) agora faz você dar um rápido passo para trás antes de investir. Se acertar um inimigo, ativa um gancho sequencial poderoso com as duas garras que arremessa os inimigos para cima." },
            { slot: "Elmo", name_en: "Bounding Accuracy", name_pt: "Precisão Arrancadora", description: "`Arrancada` (Urso) agora salta até o alvo, causando dano a todos os inimigos próximos e aumentando a velocidade de ataque e a chance de acerto crítico dos seus ataques primários." },
            { slot: "Elmo", name_en: "Bonfire Crest", name_pt: "Brasão da Fogueira", description: "`Tornado de Fogo` agora libera uma explosão no local selecionado que causa dano e queima os inimigos próximos. A habilidade pode ser ativada nos acertos críticos de ataques primários." },
            { slot: "Elmo", name_en: "The Yawning Maw", name_pt: "A Bocarra Bocejante", description: "`Evocar Urso-cinzento` agora evoca um urso flamejante que queima continuamente os inimigos próximos. Ele pode ser comandado a saltar a um local, causando dano aos inimigos e aumentando a própria chance de acerto crítico." },
            { slot: "Elmo", name_en: "Ash Monger", name_pt: "Fomentacinzas", description: "`Tornado de Fogo` agora libera um anel de fogo crescente, causando dano aos inimigos e queimando-os. Os inimigos em chamas explodem ao ficar com a vida baixa demais." },
            { slot: "Elmo", name_en: "Gilded Majesty", name_pt: "Majestade Dourada", description: "`Evocar Urso-cinzento` agora evoca um urso imbuído com o poder implacável da mata, capaz de atacar e atordoar com espinhos, consumir Energia Primitiva para reviver e receber um comando para saltar em um grupo de inimigos e provocá-los." },
            { slot: "Elmo", name_en: "Wildbrute", name_pt: "Brutalidade Selvagem", description: "`Avanço` (Lobisomem) agora faz você piscar para fora da vista, tornando-o inatingível enquanto avança, causando dano aos inimigos em seu caminho. `Avanço` pode ser usado várias vezes em rápida sucessão." },
            { slot: "Elmo", name_en: "Veiled Vice", name_pt: "Vício Velado", description: "`Uivo` (Lobisomem) também aplica Medo aos inimigos. Inimigos abaixo de uma certa porcentagem de Vida ficam com Medo por um tempo limitado. Este efeito não pode amedrontar o mesmo inimigo mais de uma vez a cada poucos segundos." },

            // Peitoral (12)
            { slot: "Peitoral", name_en: "Saved by Nature", name_pt: "Salvo pela Natureza", description: "`Círculo da Vida` agora concede uma semente regenerativa aos aliados próximos que cura constantemente e é consumida para curar um valor maior se a vida ficar baixa demais." },
            { slot: "Peitoral", name_en: "Coat of Fecundity", name_pt: "Casco da Fertilidade", description: "`Armadura de Espinhos` agora cria uma área de vinhas espinhosas que segue você, causando dano contínuo aos inimigos próximos e infectando-os com Sementes Fumegantes que explodem se o inimigo infectado estiver queimando." },
            { slot: "Peitoral", name_en: "Earthbindings", name_pt: "Laços Terrenos", description: "`Terremoto` agora golpeia o chão e fortalece você, fazendo com que você libere tremores secundários ao se mover a cada poucos metros." },
            { slot: "Peitoral", name_en: "Life Begets", name_pt: "Geravida", description: "`Círculo da Vida` agora cura você passivamente enquanto você evita receber danos e pode ser ativado para gerar uma explosão de energia que causa dano aos inimigos próximos e os atordoa. A explosão é ativada automaticamente se a sua vida ficar baixa demais." },
            { slot: "Peitoral", name_en: "Wild Surrender", name_pt: "Renúncia Selvagem", description: "`Círculo da Vida` agora é canalizado, curando a vida continuamente e gerando Energia Primitiva. Você recebe redução de dano, mas não pode se mover enquanto canaliza." },
            { slot: "Peitoral", name_en: "Saw Notch", name_pt: "Corte Serrado", description: "Na forma de `Urso`, cada inimigo abatido aumenta sua velocidade de ataque e de movimento em 8% por 4 segundos, acumulando até 3 vezes." },
            { slot: "Peitoral", name_en: "Barbmantle", name_pt: "Mantofarpa", description: "`Armadura de Espinhos` agora só protege você e, enquanto está ativa, faz seus ataques dispersarem espinhos, causando dano a inimigos próximos. A habilidade pode ser ativada com ataque primário." },
            { slot: "Peitoral", name_en: "Flesh is Fertile Ground", name_pt: "Pele Terra Fértil", description: "`Armadura de Espinhos` agora pode ser ativada ou desativada. Quando ativada, ela consome Energia Primitiva para conceder redução de dano a todos aliados próximos e causar dano contínuo aos inimigos próximos." },
            { slot: "Peitoral", name_en: "Breakplates", name_pt: "Quebra-placas", description: "`Tornado de Fogo` também estilhaça a armadura dos inimigos, aumentando o dano que recebem em 10% por 3 segundos." },
            { slot: "Peitoral", name_en: "Whispers of the Soil", name_pt: "Sussurrassolo", description: "`Terremoto` agora conjura um maelstrom turbulento de rochas no local selecionado, causando dano e petrificando os inimigos de dentro. Evocações aliadas dentro do maelstrom recebem um casco protetor, recebendo dano reduzido e imunidade a repulsão e a efeitos de perda de controle." },
            { slot: "Peitoral", name_en: "Sharval's Blessing", name_pt: "Bênção de Sharval", description: "Enquanto na forma de `Lobisomem`, você ganha Dreno de Vida adicional contra inimigos que estão abaixo de 50% de Vida." },
            { slot: "Peitoral", name_en: "Tokens of Vigilance", name_pt: "Fichas de Vigilância", description: "`Potência Raivosa` também faz com que Ataques Primários causem dano adicional igual a uma porcentagem da sua vida máxima." },

            // Ombros (12)
            { slot: "Ombros", name_en: "Grand Endurance", name_pt: "Resistência Suprema", description: "`Arrancada` (Urso) agora faz você saltar até o local de um alvo, causando dano a inimigos próximos e obtendo um escudo de absorção. Enquanto o escudo estiver ativado, você receberá dano reduzido." },
            { slot: "Ombros", name_en: "Brae’s Bark", name_pt: "Latido da Colina", description: "Na forma de `Lobisomem`, você causa 10% de dano aumentado contra inimigos sob algum efeito de dano contínuo." },
            { slot: "Ombros", name_en: "Peatspald", name_pt: "Lascaturfa", description: "`Arrancada` (Urso) aumenta sua velocidade de movimento em 40% por 3 segundos ao atingir um inimigo." },
            { slot: "Ombros", name_en: "Promise the Obscure", name_pt: "Escuridão Prometida", description: "`Laceração` (Urso) agora desfere uma sequência de quatro ataques conforme você se move a uma direção, repelindo os inimigos. Você fica imune à repulsão e perda de controle durante os ataques." },
            { slot: "Ombros", name_en: "All Are Prey", name_pt: "Tudo-presa", description: "Na forma de `Lobisomem`, você causa 20% a mais de dano aos inimigos, reduzido em 5% para cada aliado em um raio de 5 metros dos inimigos." },
            { slot: "Ombros", name_en: "Pile of Plenty", name_pt: "Pilha da Fartura", description: "A recarga de `Arrancada` (Urso) é reduzida em 0,5 segundos sempre que seu ataque primário acerta um inimigo, até o máximo de 2 segundos." },
            { slot: "Ombros", name_en: "Thrill of the Hunt", name_pt: "Emoção da Caçada", description: "Na forma de `Lobisomem`, gera 3 de Energia Primitiva para cada inimigo abatido. Só pode ser ativado uma vez a cada segundo." },
            { slot: "Ombros", name_en: "Bar-Ghaist Beacon", name_pt: "Sinal Barraspectro", description: "`Evocar Lobos` agora evoca lobos de fogo para lutar ao seu lado e queimar inimigos. Eles podem ser comandados a cuspir fogo e receber velocidade de ataque aumentada." },
            { slot: "Ombros", name_en: "Soarskull", name_pt: "Planacrânio", description: "`Enxame de Corvos` também aumenta sua velocidade de movimento em 30% por 3 segundos." },
            { slot: "Ombros", name_en: "The Great One", name_pt: "Maioral", description: "`Evocar Lobos` agora evoca um único Lobo Atroz que consome Energia Primitiva ao ser atingido para receber dano reduzido. É possível comandar o Lobo a investir aos inimigos." },
            { slot: "Ombros", name_en: "Kiegfran", name_pt: "Kiegfran", description: "`Enxame de Corvos` também gera Energia Primitiva quando atinge um inimigo, mas este efeito não pode ocorrer com mais frequência do que uma vez a cada certo período." },
            { slot: "Ombros", name_en: "Lethal Embrace", name_pt: "Abraço Letal", description: "Transformar-se em um `Lobisomem` aumenta sua Taxa de Esquiva por alguns segundos para cada ponto de Energia Primitiva que você possui atualmente, até um máximo." },

            // Calças (12)
            { slot: "Calças", name_en: "Unstoppable Redress", name_pt: "Reparação Implacável", description: "`Trincho Dilacerante` (Lobisomem) pode ser usado enquanto estiver sob efeitos de perda total de controle, consumindo 15 de Energia Primitiva e removendo o status." },
            { slot: "Calças", name_en: "Thrivegreaves", name_pt: "Grevas Prósperas", description: "`Trincho Dilacerante` (Lobisomem) consome 5 de Energia Primitiva, aumentando sua chance de acerto crítico em 25%." },
            { slot: "Calças", name_en: "Shattergrouse", name_pt: "Galo Estilhaço", description: "`Esmagamento` (Urso) também estilhaça a armadura dos inimigos, aumentando o dano que recebem em 15% por 3 segundos." },
            { slot: "Calças", name_en: "Scorched Berth", name_pt: "Leito Calcinado", description: "`Investida do Cervo` agora salta ao local selecionado, gerando Energia Primitiva com base no número de inimigos atingidos." },
            { slot: "Calças", name_en: "Ravager’s Trews", name_pt: "Calças da Destruição", description: "`Avanço` (Lobisomem) causa mais 25% de dano, mas consome 5 de Energia Primitiva ao ser usado." },
            { slot: "Calças", name_en: "Ald Abundance", name_pt: "Velha Fartura", description: "`Potência Raivosa` agora aumenta sua vida máxima até você morrer e aumenta temporariamente o dano dos seus ataques primários com base na sua Energia Primitiva atual." },
            { slot: "Calças", name_en: "Savagery Adored", name_pt: "Selvageria Venerada", description: "Usar `Trincho Dilacerante` (Lobisomem) também aumenta a chance de acerto crítico de ataques primários em 15% por 3 segundos." },
            { slot: "Calças", name_en: "Lightling Drape", name_pt: "Pano Iluminado", description: "O dano de `Evocar Sábio da Floresta` aumenta em 5% por 5 segundos cada vez que ataca, até o máximo de 20%." },
            { slot: "Calças", name_en: "Occasional Pillar", name_pt: "Pilar Casual", description: "`Pedra Impetuosa` causa 25% a mais de dano, mas consome mais 25% de Energia Primitiva." },
            { slot: "Calças", name_en: "Mudrooters", name_pt: "Radículama", description: "Suas evocações de lobo curam você em 30% do dano que eles causam." },
            { slot: "Calças", name_en: "Cackling Frenzy", name_pt: "Frenesi Sibilante", description: "`Trincho Dilacerante` (Lobisomem) agora também aumenta seu Dreno de Vida contra os inimigos atingidos por um tempo limitado, com o efeito acumulando até um máximo." },
            { slot: "Calças", name_en: "Tough Love", name_pt: "Amor Severo", description: "Ativar `Evocar Sábio da Floresta` aumenta o dano de suas evocações por um tempo limitado para cada evocação ativa, até um máximo." }
        );
        
        const skillIcons = {
            'Golpe Feroz': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/4I58T8GXLD511750697928760.jpeg" alt="Ícone de Golpe Feroz" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Deslizamento': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/6OI5JM0QXC8Q1750697929148.jpeg" alt="Ícone de Deslizamento" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Lobisomem': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/HWOXRIWDPB141750697931439.jpeg" alt="Ícone de Lobisomem" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Urso': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/0K55CULBIGSX1750697931066.jpeg" alt="Ícone de Urso" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Terremoto': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/HAWVFOW5R8G81750697927942.jpeg" alt="Ícone de Terremoto" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Tornado de Fogo': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/GWEIMO60NON41750697928796.jpeg" alt="Ícone de Tornado de Fogo" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Evocar Lobos': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/AA6QLKL6QZJS1750697930470.jpeg" alt="Ícone de Evocar Lobos" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Enxame de Corvos': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/Y1KS41Y0BOKA1750697929592.jpeg" alt="Ícone de Enxame de Corvos" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Potência Raivosa': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/YJ6OJTAFR2VX1750697929252.jpeg" alt="Ícone de Potência Raivosa" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Armadura de Espinhos': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/U6S244E6U6391750697931009.jpeg" alt="Ícone de Armadura de Espinhos" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Evocar Sábio da Floresta': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/5VM6HYSWCZWQ1750697930221.jpeg" alt="Ícone de Evocar Sábio da Floresta" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Círculo da Vida': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/8N26X6VG65CU1750697927938.jpeg" alt="Ícone de Círculo da Vida" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Investida do Cervo': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/166SILYTQOQM1750697929669.jpeg" alt="Ícone de Investida do Cervo" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Evocar Urso-cinzento': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/ZMZOWLVZR2BJ1750697930098.jpeg" alt="Ícone de Evocar Urso-cinzento" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">',
            'Pedra Impetuosa': '<img src="https://bnetcmsus-a.akamaihd.net/cms/page_media/N135ENLSG9QI1750697930618.jpeg" alt="Ícone de Pedra Impetuosa" class="w-full h-full object-cover rounded-md" onerror="this.onerror=null;this.src=\'https://placehold.co/64x64/1f2937/9ca3af?text=!\';">'
        };

        Object.assign(druidSkills, {
            primary: ['Golpe Feroz', 'Deslizamento'],
            active: [
                "Lobisomem", "Urso", "Terremoto", "Tornado de Fogo", "Evocar Lobos", "Enxame de Corvos", 
                "Potência Raivosa", "Armadura de Espinhos", "Evocar Sábio da Floresta", "Círculo da Vida", 
                "Investida do Cervo", "Evocar Urso-cinzento", "Pedra Impetuosa"
            ]
        });
        Object.assign(transformationSubSkills, {
            'Lobisomem': ['Lobisomem', 'Trincho Dilacerante', 'Avanço', 'Uivo'],
            'Urso': ['Urso', 'Esmagamento', 'Laceração', 'Arrancada']
        });

        // --- LÓGICA DA APLICAÇÃO ---
        const gearSlots = {
            'Elmo': { label: 'Elmo', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/toubg/gui_img_item_toubg_1_ovr.webp" alt="Ícone de Elmo" class="h-12 w-12">' },
            'Peitoral': { label: 'Peitoral', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/xiongbg/gui_img_item_xiongbg_1_ovr.webp" alt="Ícone de Peitoral" class="h-12 w-12">' },
            'Ombros': { label: 'Ombros', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/jianbg/gui_img_item_jianbg_1_ovr.webp" alt="Ícone de Ombros" class="h-12 w-12">' },
            'Calças': { label: 'Calças', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/tuibg/gui_img_item_tuibg_1_ovr.webp" alt="Ícone de Calças" class="h-12 w-12">' },
            'Mão Principal 1': { label: 'Mão Principal', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/zhubg/gui_img_item_zhubg_1_ovr.webp" alt="Ícone de Mão Principal" class="h-12 w-12">' },
            'Mão Principal 2': { label: 'Mão Principal', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/zhubg/gui_img_item_zhubg_1_ovr.webp" alt="Ícone de Mão Principal" class="h-12 w-12">' },
            'Mão Secundária 1': { label: 'Mão Secundária', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/fubg/gui_img_item_fubg_1_ovr.webp" alt="Ícone de Mão Secundária" class="h-12 w-12">' },
            'Mão Secundária 2': { label: 'Mão Secundária', icon: '<img src="https://wow.zamimg.com/di/ui/gui/img/item/fubg/gui_img_item_fubg_1_ovr.webp" alt="Ícone de Mão Secundária" class="h-12 w-12">' },
        };
        const gearSlotIds = Object.keys(gearSlots);
        let buildState = { skills: [null, null, null, null, null], gear: {} };
        let activeModal = { type: null, context: null };
        
        const allSkillNames = [...druidSkills.primary, ...druidSkills.active];
        const allEssenceNames = allEssences.map(e => e.name_en);


        function initializeBuild() {
            if (!loadBuildFromURL()) {
                gearSlotIds.forEach(id => buildState.gear[id] = null);
                buildState.skills = [null, null, null, null, null];
            }
            renderSkillSlots();
            renderBuildSheet();
            setupTooltipEvents();
        }

        // --- Funções de Renderização ---
        function renderSkillSlots() {
            const container = document.getElementById('skill-selection-container');
            container.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const skillName = buildState.skills[i];
                const isEmpty = !skillName;
                const slotType = i === 0 ? 'Primário' : 'Habilidade';
                
                const icon = isEmpty 
                    ? `<div class="w-12 h-12 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg></div>`
                    : `<div class="w-12 h-12">${skillIcons[skillName] || ''}</div>`;

                container.innerHTML += `
                    <div id="skill-slot-${i}"
                         onclick="openSkillModal(${i})"
                         data-skill-name="${skillName || ''}"
                         class="skill-slot w-24 cursor-pointer flex flex-col items-center justify-center p-2 rounded-lg border-2 aspect-square
                                ${isEmpty ? 'bg-gray-800/50 border-gray-700 border-dashed' : 'bg-gray-700 border-blue-500'}">
                        <div class="flex-grow flex items-center justify-center">
                            ${icon}
                        </div>
                        <p class="text-xs text-center font-semibold mt-1 leading-tight flex-shrink-0
                                  ${isEmpty ? 'text-gray-500' : 'text-blue-300'}">
                            ${isEmpty ? slotType : skillName}
                        </p>
                    </div>
                `;
            }
            setupTooltipEvents();
        }
        
        function renderBuildSheet() {
            const container = document.getElementById('build-sheet');
            container.innerHTML = `
                <div class="col-start-2" style="grid-row: 1;">${renderSlot('Elmo')}</div>
                <div class="col-start-2" style="grid-row: 2;">${renderSlot('Ombros')}</div>
                <div class="col-start-2" style="grid-row: 3;">${renderSlot('Peitoral')}</div>
                <div class="col-start-2" style="grid-row: 4;">${renderSlot('Calças')}</div>
                
                <div class="col-start-1" style="grid-row: 2;">${renderSlot('Mão Principal 1')}</div>
                <div class="col-start-1" style="grid-row: 3;">${renderSlot('Mão Principal 2')}</div>

                <div class="col-start-3" style="grid-row: 2;">${renderSlot('Mão Secundária 1')}</div>
                <div class="col-start-3" style="grid-row: 3;">${renderSlot('Mão Secundária 2')}</div>
            `;
            setupTooltipEvents();
        }

        function renderSlot(id) {
            const essence = buildState.gear[id];
            const slotInfo = gearSlots[id];
            const isEmpty = !essence;
            const selectedSkills = buildState.skills.filter(Boolean);

            let baseClasses = "gear-slot aspect-square rounded-lg border-2 flex flex-col items-center justify-center p-2";
            let stateClasses = "";
            let onClickAction = `openEssenceModal('${id}')`;
            let iconClasses = `transition-opacity duration-200 ${isEmpty ? 'opacity-40' : 'opacity-100'}`;

            if (selectedSkills.length === 0) {
                stateClasses = "bg-gray-800/50 border-gray-700 border-dashed opacity-50 cursor-not-allowed disabled";
                onClickAction = "";
            } else {
                let synergySkills = new Set();
                selectedSkills.forEach(skill => {
                    synergySkills.add(skill);
                    if (transformationSubSkills[skill]) {
                        transformationSubSkills[skill].forEach(subSkill => synergySkills.add(subSkill));
                    }
                    if (skill === 'Evocar Urso-cinzento') synergySkills.add('Urso-cinzento');
                });
                const synergyList = Array.from(synergySkills);
                const hasCompatibleEssences = allEssences.some(e => 
                    e.slot === slotInfo.label &&
                    synergyList.some(skill => e.description.includes(`\`${skill}\``))
                );

                if (isEmpty) {
                    if (hasCompatibleEssences) {
                        stateClasses = "bg-gray-800/80 border-gray-700 border-dashed cursor-pointer";
                    } else {
                        stateClasses = "bg-gray-800/50 border-gray-600 border-dashed cursor-pointer opacity-60";
                    }
                } else {
                    stateClasses = "border-blue-500 bg-gray-700/50 cursor-pointer";
                }
            }
            
            return `
                <div id="${id}" 
                     onclick="${onClickAction}" 
                     data-essence='${JSON.stringify(essence)}'
                     class="${baseClasses} ${stateClasses}">
                    <div class="${iconClasses}">${slotInfo.icon}</div>
                    <p class="text-xs text-center font-semibold mt-1 truncate w-full ${isEmpty ? 'text-gray-500' : 'text-white'}">
                        ${essence ? essence.name_pt : slotInfo.label}
                    </p>
                </div>
            `;
        }
        
        function highlightKeywords(text) {
             return text.replace(/`([^`]+)`/g, '<code class="bg-gray-600 text-blue-300 font-mono rounded px-1 py-0.5 text-xs">\$1</code>');
        }

        // --- Lógica de Modais ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('modal-overlay');
            overlay.classList.remove('hidden');
            modal.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('opacity-100');
                modal.querySelector('.modal-content').classList.replace('scale-95', 'scale-100');
            }, 10);
        }

        function closeAllModals() {
            const overlay = document.getElementById('modal-overlay');
            document.querySelectorAll('.modal-content').forEach(modalContent => {
                modalContent.classList.replace('scale-100', 'scale-95');
            });
            overlay.classList.remove('opacity-100');
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.getElementById('skill-modal').classList.add('hidden');
                document.getElementById('essence-modal').classList.add('hidden');
            }, 200);
            activeModal = { type: null, context: null };
        }

        function openSkillModal(skillIndex) {
            activeModal = { type: 'skill', context: skillIndex };
            const skillList = skillIndex === 0 ? druidSkills.primary : druidSkills.active;
            const container = document.getElementById('skill-modal-content');
            
            document.getElementById('skill-modal-title').textContent = skillIndex === 0 ? 'Escolher Ataque Primário' : `Escolher Habilidade`;
            container.innerHTML = `<div onclick="selectSkill(null)" class="cursor-pointer text-center p-3 bg-gray-700 hover:bg-red-600 rounded-lg flex flex-col items-center gap-2"><div class="w-12 h-12 text-white flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8"><path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg></div><p class="font-semibold">Nenhuma</p></div>`;

            skillList.sort().forEach(skillName => {
                const isDisabled = buildState.skills.includes(skillName) && buildState.skills[skillIndex] !== skillName;
                container.innerHTML += `
                    <div onclick="${isDisabled ? '' : `selectSkill('${skillName}')`}" class="${isDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-blue-600'} text-center p-3 bg-gray-700 rounded-lg transition-colors flex flex-col items-center gap-2">
                        <div class="w-12 h-12">${skillIcons[skillName] || ''}</div>
                        <p class="font-semibold text-sm">${skillName}</p>
                    </div>
                `;
            });
            openModal('skill-modal');
        }
        
        function openEssenceModal(slotId) {
            activeModal = { type: 'essence', context: slotId };
            const slotType = gearSlots[slotId].label;
            const container = document.getElementById('essence-modal-content');

            document.getElementById('essence-modal-title').textContent = `Selecionar - ${slotType}`;
            
            const selectedSkills = buildState.skills.filter(Boolean);
            let synergySkills = new Set();
            selectedSkills.forEach(skill => {
                synergySkills.add(skill);
                if (transformationSubSkills[skill]) {
                    transformationSubSkills[skill].forEach(subSkill => synergySkills.add(subSkill));
                }
                if (skill === 'Evocar Urso-cinzento') synergySkills.add('Urso-cinzento');
            });
            const synergyList = Array.from(synergySkills);
            
            const relevantEssences = allEssences.filter(essence => 
                essence.slot === slotType &&
                (synergyList.length === 0 || synergyList.some(skill => essence.description.includes(`\`${skill}\``)))
            );
            
            container.innerHTML = `<div onclick="selectEssence(null)" class="cursor-pointer p-3 bg-gray-700/50 hover:bg-red-600 rounded-lg text-center font-semibold">Remover Item</div>`;

            if (relevantEssences.length > 0) {
                relevantEssences.forEach(essence => {
                    let isDisabled = false;
                    if (slotType === 'Mão Principal') {
                        const otherSlotEssence = slotId === 'Mão Principal 1' ? buildState.gear['Mão Principal 2'] : buildState.gear['Mão Principal 1'];
                        if (otherSlotEssence && otherSlotEssence.name_en === essence.name_en) isDisabled = true;
                    }
                    if (slotType === 'Mão Secundária') {
                        const otherSlotEssence = slotId === 'Mão Secundária 1' ? buildState.gear['Mão Secundária 2'] : buildState.gear['Mão Secundária 1'];
                        if (otherSlotEssence && otherSlotEssence.name_en === essence.name_en) isDisabled = true;
                    }
                    
                    container.innerHTML += `
                        <div onclick="${isDisabled ? '' : `selectEssence('${essence.name_en}')`}" class="${isDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:bg-gray-700'} p-3 bg-gray-900/50 rounded-lg transition-colors">
                            <h3 class="font-bold text-lg text-blue-300">${essence.name_pt}</h3>
                            <p class="text-sm text-gray-400 font-mono mb-2">${essence.name_en}</p>
                            <p class="text-gray-300">${highlightKeywords(essence.description)}</p>
                        </div>
                    `;
                });
            } else {
                let message = selectedSkills.length > 0
                    ? `Nenhuma essência para '${slotType}' compatível com suas habilidades atuais foi encontrada.`
                    : `Nenhuma essência encontrada para '${slotType}'. Escolha primeiro uma habilidade para ver as opções.`;
                container.innerHTML += `<p class="text-center text-gray-400 p-4">${message}</p>`;
            }
            openModal('essence-modal');
        }

        // --- Lógica de Seleção e Tooltip ---
        window.selectSkill = function(skillName) {
            if (activeModal.type === 'skill') {
                buildState.skills[activeModal.context] = skillName;
                renderSkillSlots();
                renderBuildSheet(); 
                updateURLWithBuild();
                closeAllModals();
            }
        }
        
        window.selectEssence = function(essenceNameEn) {
            if (activeModal.type === 'essence') {
                if (essenceNameEn) {
                    buildState.gear[activeModal.context] = allEssences.find(e => e.name_en === essenceNameEn);
                } else {
                    buildState.gear[activeModal.context] = null;
                }
                renderBuildSheet();
                updateURLWithBuild();
                closeAllModals();
            }
        }

        function setupTooltipEvents() {
            const tooltip = document.getElementById('tooltip');
            
            document.querySelectorAll('.gear-slot').forEach(slot => {
                slot.addEventListener('mouseenter', (e) => {
                    const selectedSkills = buildState.skills.filter(Boolean);
                    if (selectedSkills.length === 0 && slot.classList.contains('disabled')) {
                        document.getElementById('tooltip-title').textContent = "Bloqueado";
                        document.getElementById('tooltip-desc').innerHTML = "Selecione pelo menos uma habilidade para ativar os slots de equipamento.";
                        tooltip.classList.remove('hidden');
                        tooltip.classList.add('opacity-100');
                        return;
                    }

                    const essenceData = slot.getAttribute('data-essence');
                    if (essenceData && essenceData !== 'null') {
                        const essence = JSON.parse(essenceData);
                        document.getElementById('tooltip-title').textContent = essence.name_pt;
                        document.getElementById('tooltip-desc').innerHTML = highlightKeywords(essence.description);
                        tooltip.classList.remove('hidden');
                        tooltip.classList.add('opacity-100');
                    }
                });

                slot.addEventListener('mouseleave', () => {
                    tooltip.classList.add('hidden');
                    tooltip.classList.remove('opacity-100');
                });
                
                slot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                });
            });

            document.querySelectorAll('.skill-slot').forEach(slot => {
                slot.addEventListener('mouseenter', (e) => {
                    const skillName = slot.getAttribute('data-skill-name');
                    if (skillName) {
                        document.getElementById('tooltip-title').textContent = skillName;
                        document.getElementById('tooltip-desc').innerHTML = '';
                        tooltip.classList.remove('hidden');
                        tooltip.classList.add('opacity-100');
                    }
                });
                slot.addEventListener('mouseleave', () => {
                    tooltip.classList.add('hidden');
                    tooltip.classList.remove('opacity-100');
                });
                 slot.addEventListener('mousemove', (e) => {
                    tooltip.style.left = `${e.clientX + 15}px`;
                    tooltip.style.top = `${e.clientY + 15}px`;
                });
            });
        }
        
        // --- Funções de Compartilhamento/URL ---
        function generateBuildCode() {
            const skillIndices = buildState.skills.map(skill => skill ? allSkillNames.indexOf(skill) : -1);
            const gearIndices = gearSlotIds.map(id => buildState.gear[id] ? allEssenceNames.indexOf(buildState.gear[id].name_en) : -1);
            const code = [...skillIndices, ...gearIndices].join(',');
            return btoa(code);
        }

        function updateURLWithBuild() {
            const code = generateBuildCode();
            const newUrl = `${window.location.pathname}?build=${code}`;
            history.pushState({ path: newUrl }, '', newUrl);
        }

        function loadBuildFromURL() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('build');
            if (!code) return false;

            try {
                const decoded = atob(code);
                const indices = decoded.split(',').map(Number);
                
                if (indices.length !== 13) return false; // 5 skills + 8 gear slots

                const skillIndices = indices.slice(0, 5);
                const gearIndices = indices.slice(5);

                buildState.skills = skillIndices.map(i => i === -1 ? null : allSkillNames[i]);
                gearSlotIds.forEach((id, index) => {
                    const essenceIndex = gearIndices[index];
                    buildState.gear[id] = essenceIndex === -1 ? null : allEssences.find(e => e.name_en === allEssenceNames[essenceIndex]);
                });
                return true;
            } catch (e) {
                console.error("Falha ao carregar a build da URL:", e);
                return false;
            }
        }
        
        function copyShareLink() {
            const btn = document.getElementById('shareBuildBtn');
            const url = window.location.href;
            
            const textArea = document.createElement("textarea");
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                const originalText = btn.innerHTML;
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Link Copiado!
                `;
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            } catch (err) {
                console.error('Falha ao copiar link: ', err);
            }
            document.body.removeChild(textArea);
        }

        // --- Funções Gerais ---
        function resetBuild() {
            history.pushState(null, '', window.location.pathname);
            buildState = { skills: [null, null, null, null, null], gear: {} };
            gearSlotIds.forEach(id => buildState.gear[id] = null);
            renderSkillSlots();
            renderBuildSheet();
        }

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            initializeBuild();
            document.getElementById('resetBuildBtn').addEventListener('click', resetBuild);
            document.getElementById('shareBuildBtn').addEventListener('click', copyShareLink);
            document.getElementById('modal-overlay').addEventListener('click', closeAllModals);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    closeAllModals();
                }
            });
        };
    </script>
</body>
</html>

